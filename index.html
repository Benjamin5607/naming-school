<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Naming School ğŸ“ (Fast Version)</title>
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding: 20px; }
    h1 { font-family: 'Anton', sans-serif; color: #ff4500; }
    #preview { max-width: 100%; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); margin: 20px auto; }
    canvas { max-width: 100%; border-radius: 20px; }
    button { padding: 10px 20px; font-size: 18px; margin: 10px; background: #ff4500; color: white; border: none; border-radius: 10px; cursor: pointer; }
    button:hover { background: #e03e00; }
    input[type="file"] { margin: 20px; }
    #loading { color: #ff4500; font-weight: bold; display: none; margin-top: 10px;}
    #regenerate { background: #333; display: none; }
    #regenerate:hover { background: #111; }
  </style>
</head>
<body>
  <h1>Naming School ğŸ“</h1>
  <p>Upload an image! AI will generate a hilarious office joke caption instantly âš¡</p>
  
  <input type="file" id="imageLoader" accept="image/*">
  <p id="loading">AI is thinking fast... ğŸ¤¯</p>
  
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" src="" alt="Sticker Preview" style="display:none;">
  
  <br>
  <button id="downloadBtn" style="display:none;">Download Sticker ğŸ“¥</button>
  <button id="regenerate" style="display:none;">New Joke ğŸ”„</button>

  <script>
    // âœ… ìµœì í™”ëœ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ (ê°€ì¥ ë¹ ë¥´ê³  ì•ˆì •ì ì¸ ëª¨ë¸ë§Œ ì‚¬ìš©)
    const modelList = [
      "gpt-4o-mini",      // í˜„ì¬ ê°€ì¥ ë¹ ë¥´ê³  ë˜‘ë˜‘í•¨
      "gpt-3.5-turbo",    // ì•ˆì •ì ì¸ ë°±ì—…
    ];

    // AI ì‹¤íŒ¨ì‹œ ì¦‰ì‹œ ë³´ì—¬ì¤„ ë¬¸êµ¬ë“¤ (ë”œë ˆì´ ë°©ì§€ìš©)
    const fallbackJokes = [
      "WHEN THE MEETING COULD'VE BEEN AN EMAIL",
      "MONDAY MORNING VIBES",
      "EXCEL CRASHED AGAIN",
      "PER MY LAST EMAIL",
      "WAITING FOR FRIDAY",
      "COFFEE IS MY BOSS",
      "DEADLINE? WHAT DEADLINE?",
      "REPLY ALL: 'THANKS'",
      "CAMERA OFF, PAJAMAS ON",
      "SENDING EMAILS... MENTALLY"
    ];

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const preview = document.getElementById('preview');
    const downloadBtn = document.getElementById('downloadBtn');
    const regenerateBtn = document.getElementById('regenerate');
    const loading = document.getElementById('loading');

    let currentImg = null;

    async function generateCaption() {
      let title = null;
      
      // ëª¨ë¸ í•˜ë‚˜ì”© ì‹œë„ (ìµœëŒ€ 2ê°œë§Œ ì‹œë„í•˜ê³  ë°”ë¡œ í¬ê¸°)
      for (const model of modelList) {
        try {
          console.log(`Trying model: ${model}...`);
          title = await puter.ai.chat(
            "Generate ONE short, funny, sarcastic English office worker meme caption. STRICTLY ALL CAPS. Examples: 'PER MY LAST EMAIL', 'DEATH BY POWERPOINT'. Just the text, nothing else.",
            { model: model }
          );
          
          if (title && typeof title === 'string' && title.trim().length > 0) {
            // ë”°ì˜´í‘œê°€ í¬í•¨ë˜ì–´ ì˜¤ë©´ ì œê±°
            return title.replace(/['"]/g, '').toUpperCase();
          }
        } catch (err) {
          console.warn(`Model ${model} failed, switching to backup...`);
        }
      }
      
      // AIê°€ ë‹¤ ì‹¤íŒ¨í•˜ê±°ë‚˜ ëŠë¦¬ë©´ ë°”ë¡œ ëœë¤ ë¬¸êµ¬ ì¶œë ¥
      console.log("AI failed, using fallback joke.");
      return fallbackJokes[Math.floor(Math.random() * fallbackJokes.length)];
    }

    async function generateSticker(img) {
      // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      
      // ë¡œë”© í‘œì‹œ
      loading.style.display = 'block';
      downloadBtn.style.display = 'none';
      regenerateBtn.style.display = 'none';

      // ìº¡ì…˜ ìƒì„±
      const title = await generateCaption();
      
      // ë¡œë”© ì¢…ë£Œ
      loading.style.display = 'none';
      
      // í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì„¤ì • (Anton í°íŠ¸)
      const fontSize = Math.min(canvas.width / 8, 100); 
      ctx.font = 'bold ' + fontSize + 'px Anton';
      ctx.fillStyle = 'white';
      ctx.strokeStyle = 'black';
      ctx.lineWidth = fontSize / 8;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      
      // í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ìƒë‹¨ ì¤‘ì•™)
      wrapText(ctx, title, canvas.width / 2, canvas.height * 0.05, canvas.width * 0.9, fontSize * 1.2);
      
      // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
      preview.src = canvas.toDataURL('image/png');
      preview.style.display = 'block';
      downloadBtn.style.display = 'inline-block';
      regenerateBtn.style.display = 'inline-block';
      
      // ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
      downloadBtn.onclick = () => {
        const link = document.createElement('a');
        link.download = 'meme_sticker.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      };
    }

    regenerateBtn.onclick = async () => {
      if (currentImg) generateSticker(currentImg);
    };

    document.getElementById('imageLoader').addEventListener('change', function(e) {
      if (e.target.files.length == 0) return;
      
      const file = e.target.files[0];
      const reader = new FileReader();
      
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          currentImg = img;
          generateSticker(img);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ í•¨ìˆ˜
    function wrapText(context, text, x, y, maxWidth, lineHeight) {
      const words = text.split(' ');
      let line = '';
      let currentY = y;

      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = context.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > maxWidth && n > 0) {
          context.strokeText(line, x, currentY);
          context.fillText(line, x, currentY);
          line = words[n] + ' ';
          currentY += lineHeight;
        } else {
          line = testLine;
        }
      }
      context.strokeText(line, x, currentY);
      context.fillText(line, x, currentY);
    }
  </script>
</body>
</html>
